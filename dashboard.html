<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Mahia</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Lora:wght@400;700&display=swap');
        body, html { margin: 0; font-family: 'Poppins', sans-serif; background-color: #f4f7f6; }
        .admin-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #2c3e50; color: white; padding: 20px; flex-shrink: 0; }
        .sidebar h1 { font-family: 'Lora', serif; font-size: 1.5em; text-align: center; }
        .sidebar nav ul { list-style: none; padding: 0; margin-top: 30px; }
        .sidebar nav a { display: block; color: white; text-decoration: none; padding: 12px 15px; border-radius: 5px; margin-bottom: 5px; transition: background-color 0.2s; }
        .sidebar nav a.active, .sidebar nav a:hover { background-color: #34495e; }
        .main-content { flex-grow: 1; padding: 30px; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .content-header h2 { margin: 0; display: flex; align-items: center; gap: 15px; font-family: 'Lora', serif; font-size: 2em; }
        .btn { padding: 10px 15px; border-radius: 5px; text-decoration: none; border: none; cursor: pointer; font-size: 0.9em; font-weight: 500; }
        .btn-primary { background-color: #0D47A1; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8em; }
        .btn-danger { background-color: #e74c3c; color: white; }
        table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background-color: #f8f9fa; font-weight: 600; }
        .actions-cell { width: 150px; text-align: right; }
        .actions-cell button { margin-left: 5px; }
        .module-container { margin-top: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .module-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }
        .module-header h3 { margin: 0; font-family: 'Lora', serif; }
        .lesson-list { list-style: none; padding: 0; margin: 0; }
        .lesson-list li { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e0e0e0; }
        .lesson-list li:last-child { border-bottom: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: #ffffff; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; }
        .modal-header h2 { margin: 0; }
        .modal-body { padding: 20px; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body label { display: block; margin-bottom: 5px; font-weight: 500; }
        .modal-body input, .modal-body textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .modal-body textarea { min-height: 200px; resize: vertical; }
        .modal-footer { padding: 20px; border-top: 1px solid #e0e0e0; text-align: right; }
        .modal-footer button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <h1>Mahia Admin</h1>
            <nav>
                <ul>
                    <li><a href="#" id="nav-paths" class="active">Parcours</a></li>
                    <li><a href="#" id="nav-preinscriptions">Pr√©inscriptions</a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content" id="main-content">
            <!-- Le contenu sera g√©n√©r√© par le script -->
        </main>
    </div>
    <!-- Fen√™tre Modale pour √©diter les le√ßons -->
    <div class="modal-overlay" id="lesson-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-title">√âditer la Le√ßon</h2></div>
            <div class="modal-body">
                <input type="hidden" id="lesson-id">
                <div class="form-group">
                    <label for="lesson-title">Titre</label>
                    <input type="text" id="lesson-title">
                </div>
                <div class="form-group">
                    <label for="lesson-description">Description</label>
                    <textarea id="lesson-description"></textarea>
                </div>
                <div class="form-group">
                    <label for="lesson-content">Contenu du Cours (Markdown)</label>
                    <textarea id="lesson-content"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-lesson-modal" class="btn-secondary">Annuler</button>
                <button id="save-lesson-modal" class="btn-primary">Sauvegarder</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const adminToken = sessionStorage.getItem('kairos_admin_token');
            const API_BASE_URL = 'https://kairos-api-njhr.onrender.com';
            const mainContent = document.getElementById('main-content');
            if (!adminToken) { window.location.href = 'admin.html'; return; }

            // --- ROUTEUR SIMPLE ---
            function navigate(view, id = null) {
                document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
                if (view === 'paths') {
                    document.getElementById('nav-paths').classList.add('active');
                    renderPathsListView();
                }
                if (view === 'path-detail') {
                    document.getElementById('nav-paths').classList.add('active');
                    renderPathDetailView(id);
                }
                if (view === 'preinscriptions') {
                    document.getElementById('nav-preinscriptions').classList.add('active');
                    renderPreinscriptionsListView();
                }
            }
            
            document.getElementById('nav-paths').addEventListener('click', (e) => { e.preventDefault(); navigate('paths'); });
            document.getElementById('nav-preinscriptions').addEventListener('click', (e) => { e.preventDefault(); navigate('preinscriptions'); });

            // --- VUE LISTE DES PARCOURS ---
            async function renderPathsListView() {
                mainContent.innerHTML = `
                    <div class="content-header">
                        <h2>Parcours de Formation</h2>
                        <button id="add-path-btn" class="btn btn-primary">+ Nouveau Parcours</button>
                    </div>
                    <table>
                        <thead><tr><th>ID</th><th>Titre</th><th class="actions-cell">Actions</th></tr></thead>
                        <tbody id="paths-table-body"><tr><td colspan="3">Chargement...</td></tr></tbody>
                    </table>`;
                
                const response = await fetch(`${API_BASE_URL}/mahia/learning-paths`);
                const paths = await response.json();
                const tableBody = document.getElementById('paths-table-body');
                tableBody.innerHTML = '';
                paths.forEach(path => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${path.id}</td>
                        <td>${path.title}</td>
                        <td class="actions-cell">
                            <button class="btn btn-secondary btn-sm manage-path-btn" data-path-id="${path.id}">G√©rer</button>
                            <button class="btn btn-sm edit-path-btn" data-path-id="${path.id}">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger delete-path-btn" data-path-id="${path.id}">üóëÔ∏è</button>
                        </td>
                    `;
                });

                document.getElementById('add-path-btn').addEventListener('click', handleAddPath);
                document.querySelectorAll('.manage-path-btn').forEach(btn => btn.addEventListener('click', () => navigate('path-detail', btn.dataset.pathId)));
                document.querySelectorAll('.edit-path-btn').forEach(btn => btn.addEventListener('click', () => handleEditPath(btn.dataset.pathId)));
                document.querySelectorAll('.delete-path-btn').forEach(btn => btn.addEventListener('click', () => handleDeletePath(btn.dataset.pathId)));
            }

            // --- VUE D√âTAIL D'UN PARCOURS ---
            async function renderPathDetailView(pathId) {
                const response = await fetch(`${API_BASE_URL}/mahia/learning-paths/${pathId}`);
                const path = await response.json();
                let modulesHtml = '';
                path.modules.forEach(module => {
                    let lessonsHtml = '<ul class="lesson-list">';
                    module.lessons.forEach(lesson => {
                        lessonsHtml += `<li><span>${lesson.title}</span><div class="actions-cell"><button class="btn btn-sm edit-lesson-btn" data-lesson-id="${lesson.id}">‚úèÔ∏è</button><button class="btn btn-sm btn-danger delete-lesson-btn" data-lesson-id="${lesson.id}">üóëÔ∏è</button></div></li>`;
                    });
                    lessonsHtml += `<li><button class="btn btn-sm add-lesson-btn" data-module-id="${module.id}">+ Le√ßon</button></li></ul>`;
                    modulesHtml += `<div class="module-container"><div class="module-header"><h3>${module.title}</h3><div class="actions-cell"><button class="btn btn-sm edit-module-btn" data-module-id="${module.id}">‚úèÔ∏è</button><button class="btn btn-sm btn-danger delete-module-btn" data-module-id="${module.id}">üóëÔ∏è</button></div></div>${lessonsHtml}</div>`;
                });

                mainContent.innerHTML = `
                    <div class="content-header">
                        <h2><button class="btn btn-secondary" id="back-to-paths">‚ùÆ</button> ${path.title}</h2>
                        <button id="add-module-btn" class="btn btn-primary">+ Nouveau Module</button>
                    </div>
                    <div id="modules-list">${modulesHtml}</div>`;

                document.getElementById('back-to-paths').addEventListener('click', () => navigate('paths'));
                document.getElementById('add-module-btn').addEventListener('click', () => handleAddModule(pathId));
                document.querySelectorAll('.add-lesson-btn').forEach(btn => btn.addEventListener('click', () => handleAddLesson(pathId, btn.dataset.moduleId)));
                document.querySelectorAll('.edit-module-btn').forEach(btn => btn.addEventListener('click', () => handleEditModule(pathId, btn.dataset.moduleId)));
                document.querySelectorAll('.delete-module-btn').forEach(btn => btn.addEventListener('click', () => handleDeleteModule(pathId, btn.dataset.moduleId)));
                document.querySelectorAll('.edit-lesson-btn').forEach(btn => btn.addEventListener('click', () => handleEditLesson(pathId, btn.dataset.lessonId)));
                document.querySelectorAll('.delete-lesson-btn').forEach(btn => btn.addEventListener('click', () => handleDeleteLesson(pathId, btn.dataset.lessonId)));
            }
            // --- VUE LISTE DES PR√âINSCRIPTIONS ---
            async function renderPreinscriptionsListView() {
                mainContent.innerHTML = `
                    <div class="content-header"><h2>Pr√©inscriptions</h2></div>
                    <table>
                        <thead><tr><th>ID</th><th>Email</th><th>Date</th></tr></thead>
                        <tbody id="preinscriptions-table-body"><tr><td colspan="3">Chargement...</td></tr></tbody>
                    </table>`;
                
                const response = await fetch(`${API_BASE_URL}/admin/mahia/preinscriptions`, { headers: { 'Authorization': `Bearer ${adminToken}` } });
                const preinscriptions = await response.json();
                const tableBody = document.getElementById('preinscriptions-table-body');
                tableBody.innerHTML = '';
                preinscriptions.forEach(p => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td>${p.id}</td><td>${p.email}</td><td>${new Date(p.created_at).toLocaleString('fr-FR')}</td>`;
                });
            }

            // --- GESTIONNAIRES D'√âV√âNEMENTS (HANDLERS) ---
            async function handleAddPath() {
                const title = prompt("Titre du nouveau parcours :");
                if (title && title.trim()) {
                    await fetch(`${API_BASE_URL}/admin/mahia/learning-paths`, { method: 'POST', headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ title, description: "Nouvelle description" }) });
                    navigate('paths');
                }
            }
            async function handleEditPath(pathId) {
                const newTitle = prompt("Nouveau titre pour le parcours :");
                if (newTitle && newTitle.trim()) {
                    await fetch(`${API_BASE_URL}/admin/mahia/learning-paths/${pathId}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ title: newTitle }) });
                    navigate('paths');
                }
            }
            async function handleDeletePath(pathId) {
                if (confirm("√ätes-vous s√ªr de vouloir supprimer ce parcours ? TOUS ses modules et le√ßons seront perdus.")) {
                    await fetch(`${API_BASE_URL}/admin/mahia/learning-paths/${pathId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${adminToken}` } });
                    navigate('paths');
                }
            }
            async function handleAddModule(pathId) {
                const title = prompt("Titre du nouveau module :");
                if (title && title.trim()) {
                    await fetch(`${API_BASE_URL}/admin/mahia/paths/${pathId}/modules`, { method: 'POST', headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ title }) });
                    navigate('path-detail', pathId);
                }
            }
            async function handleEditModule(pathId, moduleId) {
                const newTitle = prompt("Nouveau titre pour le module :");
                if (newTitle && newTitle.trim()) {
                    await fetch(`${API_BASE_URL}/admin/mahia/modules/${moduleId}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ title: newTitle }) });
                    navigate('path-detail', pathId);
                }
            }
            async function handleDeleteModule(pathId, moduleId) {
                if (confirm("√ätes-vous s√ªr de vouloir supprimer ce module ?")) {
                    await fetch(`${API_BASE_URL}/admin/mahia/modules/${moduleId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${adminToken}` } });
                    navigate('path-detail', pathId);
                }
            }
            async function handleAddLesson(pathId, moduleId) {
                const title = prompt("Titre de la nouvelle le√ßon :");
                if (title && title.trim()) {
                    await fetch(`${API_BASE_URL}/admin/mahia/modules/${moduleId}/lessons`, { method: 'POST', headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ title, description: "Nouvelle description" }) });
                    navigate('path-detail', pathId);
                }
            }
            async function handleEditLesson(pathId, lessonId) {
                const lessonModal = document.getElementById('lesson-modal');
                const lesson = await fetch(`${API_BASE_URL}/mahia/lessons/${lessonId}`).then(res => res.json());
                
                document.getElementById('lesson-id').value = lesson.id;
                document.getElementById('lesson-title').value = lesson.title;
                document.getElementById('lesson-description').value = lesson.description;
                document.getElementById('lesson-content').value = lesson.content;
                
                lessonModal.classList.add('visible');
                
                document.getElementById('save-lesson-modal').onclick = async () => {
                    const data = {
                        title: document.getElementById('lesson-title').value,
                        description: document.getElementById('lesson-description').value,
                        content: document.getElementById('lesson-content').value
                    };
                    await fetch(`${API_BASE_URL}/admin/mahia/lessons/${lessonId}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                    lessonModal.classList.remove('visible');
                    navigate('path-detail', pathId);
                };
                document.getElementById('cancel-lesson-modal').onclick = () => lessonModal.classList.remove('visible');
            }
            async function handleDeleteLesson(pathId, lessonId) {
                if (confirm("√ätes-vous s√ªr de vouloir supprimer cette le√ßon ?")) {
                    await fetch(`${API_BASE_URL}/admin/mahia/lessons/${lessonId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${adminToken}` } });
                    navigate('path-detail', pathId);
                }
            }

            // --- CHARGEMENT INITIAL ---
            navigate('paths');
        });
    </script>
</body>
</html>